DROP TABLE IF EXISTS USERS, ITEMS, BOOKINGS, COMMENTS, REQUESTS;
DROP TYPE IF EXISTS BOOKING_STATUS;

CREATE TABLE IF NOT EXISTS USERS
(
    ID    INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    EMAIL VARCHAR(255) NOT NULL,
    NAME  VARCHAR(255) NOT NULL
);

CREATE UNIQUE INDEX EMAIL_INDEX ON USERS (EMAIL);

CREATE TABLE IF NOT EXISTS REQUESTS
(
    ID          INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    DESCRIPTION VARCHAR(1000) NOT NULL,
    USER_ID     INTEGER       NOT NULL REFERENCES USERS (ID),
    CREATED     TIMESTAMP DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS ITEMS
(
    ID           INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NAME         VARCHAR(255) NOT NULL,
    DESCRIPTION  VARCHAR(255) NOT NULL,
    IS_AVAILABLE BOOLEAN      NOT NULL,
    OWNER_ID     INTEGER      NOT NULL REFERENCES USERS (ID) ON DELETE CASCADE,
    REQUEST_ID   INTEGER      NULL REFERENCES REQUESTS (ID)
);

CREATE TYPE BOOKING_STATUS AS ENUM ('WAITING', 'APPROVED', 'REJECTED');

CREATE TABLE IF NOT EXISTS BOOKINGS
(
    ID              INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    START_TIMESTAMP TIMESTAMP      NOT NULL,
    END_TIMESTAMP   TIMESTAMP      NOT NULL,
    STATUS          BOOKING_STATUS NOT NULL,
    BOOKER_ID       INTEGER        NOT NULL REFERENCES USERS (ID),
    ITEM_ID         INTEGER        NOT NULL REFERENCES ITEMS (ID)
);

CREATE TABLE IF NOT EXISTS COMMENTS
(
    ID        INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    TEXT      VARCHAR(5000) NOT NULL,
    AUTHOR_ID INTEGER       NOT NULL REFERENCES USERS (ID),
    ITEM_ID   INTEGER       NOT NULL REFERENCES ITEMS (ID) ON DELETE CASCADE,
    CREATED   TIMESTAMP DEFAULT NOW()
);